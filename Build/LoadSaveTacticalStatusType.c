#include "Debug.h"
#include "FileMan.h"
#include "LoadSaveData.h"
#include "LoadSaveTacticalStatusType.h"
#include "Overhead.h"


BOOLEAN ExtractTacticalStatusTypeFromFile(const HWFILE f)
{
#ifdef _WIN32
	BYTE data[316];
#else
	BYTE data[360];
#endif
	if (!FileRead(f, data, sizeof(data))) return FALSE;

	TacticalStatusType* const s = &gTacticalStatus;
	const BYTE* d = data;
	EXTR_U32(d, s->uiFlags)
	for (TacticalTeamType* t = s->Team; t != endof(s->Team); ++t)
	{
		EXTR_U8(d, t->bFirstID)
		EXTR_U8(d, t->bLastID)
		EXTR_SKIP(d, 2)
		EXTR_U32(d, t->RadarColor)
		EXTR_I8(d, t->bSide)
		EXTR_I8(d, t->bMenInSector)
		EXTR_U8(d, t->ubLastMercToRadio)
		EXTR_I8(d, t->bTeamActive_UNUNSED)
		EXTR_I8(d, t->bAwareOfOpposition)
		EXTR_I8(d, t->bHuman)
		EXTR_SKIP(d, 2)
	}
	EXTR_U8(d, s->ubCurrentTeam)
	EXTR_SKIP(d, 1)
	EXTR_I16(d, s->sSlideTarget)
	EXTR_I16(d, s->sSlideReason)
	EXTR_SKIP(d, 2)
	EXTR_U32(d, s->uiTimeSinceMercAIStart)
	EXTR_I8(d, s->fPanicFlags)
	EXTR_SKIP(d, 1)
	EXTR_I16(d, s->sPanicTriggerGridno_UNUSED)
	EXTR_I16(d, s->sHandGrid_UNUSED)
	EXTR_U8(d, s->ubSpottersCalledForBy)
	EXTR_U8(d, s->ubTheChosenOne)
	EXTR_U32(d, s->uiTimeOfLastInput)
	EXTR_U32(d, s->uiTimeSinceDemoOn)
	EXTR_U32(d, s->uiCountdownToRestart_UNUSED)
	EXTR_BOOL(d, s->fGoingToEnterDemo_UNUSED)
	EXTR_BOOL(d, s->fNOTDOLASTDEMO_UNUSED)
	EXTR_BOOL(d, s->fMultiplayer_UNUSED)
	EXTR_BOOLA(d, s->fCivGroupHostile, lengthof(s->fCivGroupHostile))
	EXTR_U8(d, s->ubLastBattleSectorX)
	EXTR_U8(d, s->ubLastBattleSectorY)
	EXTR_BOOL(d, s->fLastBattleWon)
	EXTR_I8(d, s->bOriginalSizeOfEnemyForce)
	EXTR_I8(d, s->bPanicTriggerIsAlarm_UNUSED)
	EXTR_BOOL(d, s->fVirginSector)
	EXTR_BOOL(d, s->fEnemyInSector)
	EXTR_BOOL(d, s->fInterruptOccurred)
	EXTR_I8(d, s->bRealtimeSpeed)
	EXTR_U8(d, s->ubEnemyIntention_UNUSED)
	EXTR_U8(d, s->ubEnemyIntendedRetreatDirection_UNUSED)
	EXTR_U8(d, s->ubEnemySightingOnTheirTurnEnemyID)
	EXTR_U8(d, s->ubEnemySightingOnTheirTurnPlayerID_UNUSED)
	EXTR_BOOL(d, s->fEnemySightingOnTheirTurn)
	EXTR_BOOL(d, s->fAutoBandageMode)
	EXTR_U8(d, s->ubAttackBusyCount)
	EXTR_I8(d, s->bNumEnemiesFoughtInBattle_UNUSED)
	EXTR_U8(d, s->ubEngagedInConvFromActionMercID)
	EXTR_SKIP(d, 1)
	EXTR_U16(d, s->usTactialTurnLimitCounter)
	EXTR_BOOL(d, s->fInTopMessage)
	EXTR_U8(d, s->ubTopMessageType)
#ifdef _WIN32
	EXTR_WSTR16(d, s->zTopMessageString, lengthof(s->zTopMessageString))
#else
	EXTR_SKIP(d, 2)
	EXTR_WSTR32(d, s->zTopMessageString, lengthof(s->zTopMessageString))
#endif
	EXTR_U16(d, s->usTactialTurnLimitMax)
#ifndef _WIN32
	EXTR_SKIP(d, 2)
#endif
	EXTR_U32(d, s->uiTactialTurnLimitClock)
	EXTR_BOOL(d, s->fTactialTurnLimitStartedBeep)
	EXTR_I8(d, s->bBoxingState)
	EXTR_I8(d, s->bConsNumTurnsNotSeen)
	EXTR_U8(d, s->ubArmyGuysKilled)
	EXTR_I16A(d, s->sPanicTriggerGridNo, lengthof(s->sPanicTriggerGridNo))
	EXTR_I8A(d, s->bPanicTriggerIsAlarm, lengthof(s->bPanicTriggerIsAlarm))
	EXTR_U8A(d, s->ubPanicTolerance, lengthof(s->ubPanicTolerance))
	EXTR_BOOL(d, s->fAtLeastOneGuyOnMultiSelect)
	EXTR_BOOL(d, s->fSaidCreatureFlavourQuote_UNUSED)
	EXTR_BOOL(d, s->fHaveSeenCreature_UNUSED)
	EXTR_BOOL(d, s->fKilledEnemyOnAttack)
	EXTR_U8(d, s->ubEnemyKilledOnAttack)
	EXTR_I8(d, s->bEnemyKilledOnAttackLevel)
	EXTR_U16(d, s->ubEnemyKilledOnAttackLocation)
	EXTR_BOOL(d, s->fItemsSeenOnAttack)
	EXTR_BOOL(d, s->ubItemsSeenOnAttackSoldier)
	EXTR_BOOL(d, s->fBeenInCombatOnce_UNUSED)
	EXTR_BOOL(d, s->fSaidCreatureSmellQuote_UNUSED)
	EXTR_U16(d, s->usItemsSeenOnAttackGridNo)
	EXTR_BOOL(d, s->fLockItemLocators)
	EXTR_U8(d, s->ubLastQuoteSaid)
	EXTR_U8(d, s->ubLastQuoteProfileNUm)
	EXTR_BOOL(d, s->fCantGetThrough)
	EXTR_I16(d, s->sCantGetThroughGridNo)
	EXTR_I16(d, s->sCantGetThroughSoldierGridNo)
	EXTR_U8(d, s->ubCantGetThroughID)
	EXTR_BOOL(d, s->fDidGameJustStart)
	EXTR_BOOL(d, s->fStatChangeCheatOn_UNUSED)
	EXTR_U8(d, s->ubLastRequesterTargetID)
	EXTR_BOOL(d, s->fGoodToAllowCrows)
	EXTR_U8(d, s->ubNumCrowsPossible)
	EXTR_U32(d, s->uiTimeCounterForGiveItemSrc_UNUSED)
	EXTR_BOOL(d, s->fUnLockUIAfterHiddenInterrupt)
	EXTR_I8A(d, s->bNumFoughtInBattle, lengthof(s->bNumFoughtInBattle))
	EXTR_SKIP(d, 1)
	EXTR_U32(d, s->uiDecayBloodLastUpdate)
	EXTR_U32(d, s->uiTimeSinceLastInTactical)
	EXTR_BOOL(d, s->fHasAGameBeenStarted)
	EXTR_I8(d, s->bConsNumTurnsWeHaventSeenButEnemyDoes)
	EXTR_BOOL(d, s->fSomeoneHit)
	EXTR_U8(d, s->ubPaddingSmall_UNUSED)
	EXTR_U32(d, s->uiTimeSinceLastOpplistDecay)
	EXTR_I8(d, s->bMercArrivingQuoteBeingUsed)
	EXTR_U8(d, s->ubEnemyKilledOnAttackKiller)
	EXTR_BOOL(d, s->fCountingDownForGuideDescription)
	EXTR_I8(d, s->bGuideDescriptionCountDown)
	EXTR_U8(d, s->ubGuideDescriptionToUse)
	EXTR_I8(d, s->bGuideDescriptionSectorX)
	EXTR_I8(d, s->bGuideDescriptionSectorY)
	EXTR_I8(d, s->fEnemyFlags)
	EXTR_BOOL(d, s->fAutoBandagePending)
	EXTR_BOOL(d, s->fHasEnteredCombatModeSinceEntering)
	EXTR_BOOL(d, s->fDontAddNewCrows)
	EXTR_U8(d, s->ubMorePadding_UNUSED)
	EXTR_U16(d, s->sCreatureTenseQuoteDelay)
	EXTR_SKIP(d, 2)
	EXTR_U32(d, s->uiCreatureTenseQuoteLastUpdate)
	Assert(d == endof(data));

	return TRUE;
}


BOOLEAN InjectTacticalStatusTypeIntoFile(const HWFILE f)
{
#ifdef _WIN32
	BYTE data[316];
#else
	BYTE data[360];
#endif
	BYTE*                     d = data;
	TacticalStatusType* const s = &gTacticalStatus;
	INJ_U32(d, s->uiFlags)
	for (TacticalTeamType* t = s->Team; t != endof(s->Team); ++t)
	{
		INJ_U8(d, t->bFirstID)
		INJ_U8(d, t->bLastID)
		INJ_SKIP(d, 2)
		INJ_U32(d, t->RadarColor)
		INJ_I8(d, t->bSide)
		INJ_I8(d, t->bMenInSector)
		INJ_U8(d, t->ubLastMercToRadio)
		INJ_I8(d, t->bTeamActive_UNUNSED)
		INJ_I8(d, t->bAwareOfOpposition)
		INJ_I8(d, t->bHuman)
		INJ_SKIP(d, 2)
	}
	INJ_U8(d, s->ubCurrentTeam)
	INJ_SKIP(d, 1)
	INJ_I16(d, s->sSlideTarget)
	INJ_I16(d, s->sSlideReason)
	INJ_SKIP(d, 2)
	INJ_U32(d, s->uiTimeSinceMercAIStart)
	INJ_I8(d, s->fPanicFlags)
	INJ_SKIP(d, 1)
	INJ_I16(d, s->sPanicTriggerGridno_UNUSED)
	INJ_I16(d, s->sHandGrid_UNUSED)
	INJ_U8(d, s->ubSpottersCalledForBy)
	INJ_U8(d, s->ubTheChosenOne)
	INJ_U32(d, s->uiTimeOfLastInput)
	INJ_U32(d, s->uiTimeSinceDemoOn)
	INJ_U32(d, s->uiCountdownToRestart_UNUSED)
	INJ_BOOL(d, s->fGoingToEnterDemo_UNUSED)
	INJ_BOOL(d, s->fNOTDOLASTDEMO_UNUSED)
	INJ_BOOL(d, s->fMultiplayer_UNUSED)
	INJ_BOOLA(d, s->fCivGroupHostile, lengthof(s->fCivGroupHostile))
	INJ_U8(d, s->ubLastBattleSectorX)
	INJ_U8(d, s->ubLastBattleSectorY)
	INJ_BOOL(d, s->fLastBattleWon)
	INJ_I8(d, s->bOriginalSizeOfEnemyForce)
	INJ_I8(d, s->bPanicTriggerIsAlarm_UNUSED)
	INJ_BOOL(d, s->fVirginSector)
	INJ_BOOL(d, s->fEnemyInSector)
	INJ_BOOL(d, s->fInterruptOccurred)
	INJ_I8(d, s->bRealtimeSpeed)
	INJ_U8(d, s->ubEnemyIntention_UNUSED)
	INJ_U8(d, s->ubEnemyIntendedRetreatDirection_UNUSED)
	INJ_U8(d, s->ubEnemySightingOnTheirTurnEnemyID)
	INJ_U8(d, s->ubEnemySightingOnTheirTurnPlayerID_UNUSED)
	INJ_BOOL(d, s->fEnemySightingOnTheirTurn)
	INJ_BOOL(d, s->fAutoBandageMode)
	INJ_U8(d, s->ubAttackBusyCount)
	INJ_I8(d, s->bNumEnemiesFoughtInBattle_UNUSED)
	INJ_U8(d, s->ubEngagedInConvFromActionMercID)
	INJ_SKIP(d, 1)
	INJ_U16(d, s->usTactialTurnLimitCounter)
	INJ_BOOL(d, s->fInTopMessage)
	INJ_U8(d, s->ubTopMessageType)
#ifdef _WIN32
	INJ_WSTR16(d, s->zTopMessageString, lengthof(s->zTopMessageString))
#else
	INJ_SKIP(d, 2)
	INJ_WSTR32(d, s->zTopMessageString, lengthof(s->zTopMessageString))
#endif
	INJ_U16(d, s->usTactialTurnLimitMax)
#ifndef _WIN32
	INJ_SKIP(d, 2)
#endif
	INJ_U32(d, s->uiTactialTurnLimitClock)
	INJ_BOOL(d, s->fTactialTurnLimitStartedBeep)
	INJ_I8(d, s->bBoxingState)
	INJ_I8(d, s->bConsNumTurnsNotSeen)
	INJ_U8(d, s->ubArmyGuysKilled)
	INJ_I16A(d, s->sPanicTriggerGridNo, lengthof(s->sPanicTriggerGridNo))
	INJ_I8A(d, s->bPanicTriggerIsAlarm, lengthof(s->bPanicTriggerIsAlarm))
	INJ_U8A(d, s->ubPanicTolerance, lengthof(s->ubPanicTolerance))
	INJ_BOOL(d, s->fAtLeastOneGuyOnMultiSelect)
	INJ_BOOL(d, s->fSaidCreatureFlavourQuote_UNUSED)
	INJ_BOOL(d, s->fHaveSeenCreature_UNUSED)
	INJ_BOOL(d, s->fKilledEnemyOnAttack)
	INJ_U8(d, s->ubEnemyKilledOnAttack)
	INJ_I8(d, s->bEnemyKilledOnAttackLevel)
	INJ_U16(d, s->ubEnemyKilledOnAttackLocation)
	INJ_BOOL(d, s->fItemsSeenOnAttack)
	INJ_BOOL(d, s->ubItemsSeenOnAttackSoldier)
	INJ_BOOL(d, s->fBeenInCombatOnce_UNUSED)
	INJ_BOOL(d, s->fSaidCreatureSmellQuote_UNUSED)
	INJ_U16(d, s->usItemsSeenOnAttackGridNo)
	INJ_BOOL(d, s->fLockItemLocators)
	INJ_U8(d, s->ubLastQuoteSaid)
	INJ_U8(d, s->ubLastQuoteProfileNUm)
	INJ_BOOL(d, s->fCantGetThrough)
	INJ_I16(d, s->sCantGetThroughGridNo)
	INJ_I16(d, s->sCantGetThroughSoldierGridNo)
	INJ_U8(d, s->ubCantGetThroughID)
	INJ_BOOL(d, s->fDidGameJustStart)
	INJ_BOOL(d, s->fStatChangeCheatOn_UNUSED)
	INJ_U8(d, s->ubLastRequesterTargetID)
	INJ_BOOL(d, s->fGoodToAllowCrows)
	INJ_U8(d, s->ubNumCrowsPossible)
	INJ_U32(d, s->uiTimeCounterForGiveItemSrc_UNUSED)
	INJ_BOOL(d, s->fUnLockUIAfterHiddenInterrupt)
	INJ_I8A(d, s->bNumFoughtInBattle, lengthof(s->bNumFoughtInBattle))
	INJ_SKIP(d, 1)
	INJ_U32(d, s->uiDecayBloodLastUpdate)
	INJ_U32(d, s->uiTimeSinceLastInTactical)
	INJ_BOOL(d, s->fHasAGameBeenStarted)
	INJ_I8(d, s->bConsNumTurnsWeHaventSeenButEnemyDoes)
	INJ_BOOL(d, s->fSomeoneHit)
	INJ_U8(d, s->ubPaddingSmall_UNUSED)
	INJ_U32(d, s->uiTimeSinceLastOpplistDecay)
	INJ_I8(d, s->bMercArrivingQuoteBeingUsed)
	INJ_U8(d, s->ubEnemyKilledOnAttackKiller)
	INJ_BOOL(d, s->fCountingDownForGuideDescription)
	INJ_I8(d, s->bGuideDescriptionCountDown)
	INJ_U8(d, s->ubGuideDescriptionToUse)
	INJ_I8(d, s->bGuideDescriptionSectorX)
	INJ_I8(d, s->bGuideDescriptionSectorY)
	INJ_I8(d, s->fEnemyFlags)
	INJ_BOOL(d, s->fAutoBandagePending)
	INJ_BOOL(d, s->fHasEnteredCombatModeSinceEntering)
	INJ_BOOL(d, s->fDontAddNewCrows)
	INJ_U8(d, s->ubMorePadding_UNUSED)
	INJ_U16(d, s->sCreatureTenseQuoteDelay)
	INJ_SKIP(d, 2)
	INJ_U32(d, s->uiCreatureTenseQuoteLastUpdate)
	Assert(d == endof(data));

	return FileWrite(f, data, sizeof(data));
}
